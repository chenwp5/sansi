# MySQL技术规范

## 一、分表/分区

### 1、规范要求

```
整个实例的数据文件个数，不应超过131062个，不宜超过60000个
```

### 2、原理说明

- 生产环境使用XtraBackup对MySQL进行数据备份，备份时所需的文件描述符个数最多为（数据文件个数+10），该数量不能超过操作系统ulimit的nofile上限（我行MySQL服务器最大基线为131072），否则备份会失败。因此，一个MySQL实力的数据文件格式不应超过（131072 - 10）=131062。
- 数据文件计算公式：对于分区表，每个分区对应一个数据文件，对于非分区表，每个表对应一个数据文件。即MySQL实例数据文件个数 = 表分区数 + 非分区表个数。如果使用子分区，每个子分区也是对应一个数据文件。
- 表/分区个数越多，MySQL内存占用越大。

### 3、案例

数据文件较多的一个案例：

```sql
select count(*) from information_schema.tables;
+----------+
| count(*) |
+----------+
|     803  |
+----------+

select count(*) from information_schema.partitions;
+----------+
| count(*) |
+----------+
|   104530 |
+----------+
```

## 二、主键

### 1、规范要求

```
对于记录数超过1万条的表，应使用自增主键，且类型为：[满足条件的int类型] unsigned。
```

![](./img/int-size.png)

### 2、原理说明【待完善】

- MySQL的表示聚集索引表（Clustered Index Table），跟Oracle、DB2不一样。如果主键是递增插入的，读写性能比较高。

### 3、关于业务主键

使用自增列作为主键时，业务逻辑设置为唯一索引。

## 三、连接

### 1、规范要求

```
如果应用使用数据库连接池，应有心跳机制。
应用与数据库的连接数，不应超过数据库 max_connections 参数设置。
应用应通过正常的方式关闭数据库连接。
```

### 2、原理说明

- 参数wait_timeout: 如果数据库连接的空闲时间超过该值，MySQL主动断开。大基线：1小时。
- 参数max_connections设置数据库允许的最大连接数，如果超过报"Too many connections"，该值并不是越大越好，并发的用户活动数越大，用户线程占用的内存越多。大基线：512。
- 不正常关闭连接，可能导致连接泄露。数据库连接池认为该连接仍在使用中，不会提供给其他程序使用，最导致可用连接耗尽，程序报错。

### 3、解决方案  

- 设置连接池的定时心跳（或称探活），可以避免该问题。

But 现实环境中需要你考虑的是（假设连接池使用c3p0）：

1. 你设置多久检查一次连接有效的时间 依据是什么？
2. 默认加大/减小wait_timeout除了解决当前问题，会不会带来其他影响？

个人当前觉得此题 第一需考虑的是：
 **1. 你业务当前高峰期mysql_connection是多少？保留多久connection在高峰期都不会撑爆你数据库连接池？**
 **2. 如果你知道这个池-那么是改mysql ？还是改c3p0？还是双管齐下都是有据可循且不会带来后遗症的-最佳解决方案**

例如一个后台管理系统，使用人数在50以内，那么我wait_timeout 就是默认8小时，c3p0不用做连接有效性检查等，都是万事ok的。

而我还有一个EPG前台管理系统，用户量在300万以内，如果我wait_timeout为8小时，那我一到高峰期肯定就是死翘翘的，会有太多的TCP连接没关闭，数据库连接数肯定是不够的。因EPG的一个访问对数据库操作量不大，查询完数据就完成ok啦，wait_timeout 设置在120s内应该是够用啦，那么相对应的c3p0中 设置小于wait_timeout 的时间有效性检查，就能确保获取到连接是有效的。

**请根据业务场景，来配置参数，不要解决了A问题，带来了B问题。**

## 四、索引匹配

## 五、数据更新

## 六、数据清理

## 七、事务

## 八、表结构变更

